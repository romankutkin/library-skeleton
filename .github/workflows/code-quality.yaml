name: Code Quality

on:
    push:
        branches:
            # TODO: change branch
            - feature/test-github-actions
    pull_request:
        branches:
            # TODO: change branch
            - feature/test-github-actions

jobs:
    pull-image:
        name: Pull Docker Image
        runs-on: ubuntu-latest
        strategy:
            matrix:
                php_version: [ "8.3", "8.4" ]
        steps:
            -   name: Login in private docker registry
                run: |
                    echo "${{ secrets.DOCKER_REGISTRY_PASSWORD }}" | docker login ${{ secrets.DOCKER_REGISTRY_HOST }} \
                        -u ${{ secrets.DOCKER_REGISTRY_USERNAME }} --password-stdin

            -   name: Pull docker image
                run: |
                    docker pull ${{ secrets.DOCKER_REGISTRY_HOST }}/library-name/php:${{ matrix.php_version }}-cli

    run-analyze:
        name: Run Static Analyze
        needs: pull-image
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Install composer dependencies
                run: |
                    docker run --rm \
                        -v ${{ github.workspace }}:/srv/library \
                        -w /srv/library \
                        ${{ secrets.DOCKER_REGISTRY_HOST }}/library-name/php:${{ matrix.php_version }}-cli \
                        composer install --no-interaction

            -   name: Run PHPStan
                run: |
                    docker run --rm \
                        -v ${{ github.workspace }}:/srv/library \
                        -w /srv/library \
                        ${{ secrets.DOCKER_REGISTRY_HOST }}/library-name/php:${{ matrix.php_version }}-cli \
                        vendor/bin/phpstan analyze -l 10 src tests

    run-test:
        name: Run Test
        needs: pull-image
        runs-on: ubuntu-latest
        strategy:
            matrix:
                php_version: [ "8.3", "8.4" ]
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Install composer dependencies
                run: |
                    docker run --rm \
                        -v ${{ github.workspace }}:/srv/library \
                        -w /srv/library \
                        ${{ secrets.DOCKER_REGISTRY_HOST }}/library-name/php:${{ matrix.php_version }}-cli \
                        composer install --no-interaction

            -   name: Run PHPUnit
                run: |
                    docker run --rm \
                        -v ${{ github.workspace }}:/srv/library \
                        -w /srv/library \
                        ${{ secrets.DOCKER_REGISTRY_HOST }}/library-name/php:${{ matrix.php_version }}-cli \
                        vendor/bin/phpunit
